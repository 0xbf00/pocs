LDFLAGS =-Wl,-sectcreate,__TEXT,__info_plist,Info.plist

# Adapt signing identity to locally available cert name
SIGNING_IDENTITY=Developer
TARGETS=sandboxed-poc unsandboxed-poc

catalina: CFLAGS += -DMAC_OS_CATALINA
catalina: clean $(TARGETS)
	@echo Built $(TARGETS) for macOS Catalina.

mojave: clean $(TARGETS)
	@echo Built $(TARGETS) for macOS Mojave.

interpose_lib.dylib: interpose_lib.c
	clang -o interpose_lib.dylib -dynamiclib interpose_lib.c $(CFLAGS)

sandboxed-poc: sandbox-poc.c
	clang -o sandboxed-poc sandbox-poc.c $(LDFLAGS)
	codesign --force -s $(SIGNING_IDENTITY) --entitlements entitlements.xml sandboxed-poc

unsandboxed-poc: sandbox-poc.c interpose_lib.dylib
	clang -o unsandboxed-poc sandbox-poc.c interpose_lib.dylib $(LDFLAGS)
	codesign --force -s $(SIGNING_IDENTITY) --entitlements entitlements.xml unsandboxed-poc

clean:
	rm -f sandboxed-poc unsandboxed-poc interpose_lib.dylib